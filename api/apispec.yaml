openapi: 3.0.0
info:
  title: Tawny
  description: |-
    A lastfm Api Proxy

    https://github.com/dozro/tawny/tree/main
  version: 0.1.0
servers:
  - url: /api/v1
tags:
  - name: user
    description: Operations related to users
  - name: hmac
    description: Operations related to hmac
paths:
  '/user/{username}':
    get:
      description: |-
        Get User Info

        Lastfm Docu: https://www.last.fm/api/show/user.getInfo
      security:
        - defaultApiKey: []
      parameters:
        - name: username
          in: path
          required: true
          description: the username
          schema:
            type: string
            example: alice
            pattern: "^[a-zA-Z0-9_-]{3,20}$"
            minLength: 3
            maxLength: 20
      responses:
        '200':
          description: The fetched User Info
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/userinfo'
        '401':
          $ref: '#/components/responses/ApiErrorReturn401'
        '500':
          description: internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/internalError'
      summary: Get User Info
      operationId: get_user
      tags:
        - user
  '/user/{username}/tracks/loved':
    get:
      description: 'Get loved tracks of specified User - https://www.last.fm/api/show/user.getLovedTracks'
      security:
        - defaultApiKey: []
      parameters:
        - name: limit
          in: query
          required: false
          description: The limit
          schema:
            type: number
        - name: page
          in: query
          required: false
          description: The page you want to get
          schema:
            type: number
        - name: username
          in: path
          required: true
          description: the username
          schema:
            type: string
            pattern: "^[a-zA-Z0-9_-]{3,20}$"
            minLength: 3
            maxLength: 20
        - name: signature
          in: query
          required: false
          description: the HMAC Signature for this OP
          schema:
            type: string
            pattern: "^[A-Fa-f0-9]{64}$"
            maxLength: 64
            minLength: 64
      responses:
        '200':
          description: the fetched list of loved songs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserLovedTracks'
        '307':
          description: a redirect
        '401':
          $ref: '#/components/responses/ApiErrorReturn401'
        '500':
          description: internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/internalError'
      summary: Get Users Loved Tracks
      operationId: user_get_loved_tracks
      tags:
        - user
  '/user/{username}/tracks/recent':
    get:
      summary: get recent tracks
      tags:
        - user
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserRecentTracks'
        '401':
          $ref: '#/components/responses/ApiErrorReturn401'
        '500':
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/internalError'
      operationId: 'get_user_username_tracks_recent'
      parameters:
        - schema:
            type: integer
            format: int32
            default: 25
            minimum: 1
            maximum: 250
          in: query
          name: limit
          description: The limit
        - schema:
            type: integer
            format: int64
            default: 1
            minimum: 1
            maximum: 32000
          in: query
          name: page
          description: The page
        - name: signature
          in: query
          required: false
          description: the HMAC Signature for this OP
          schema:
            type: string
            pattern: "^[A-Fa-f0-9]{64}$"
            minLength: 64
            maxLength: 64
        - name: fetch_musicbrainz
          in: query
          required: false
          schema:
            type: boolean
            default: false
        - name: username
          in: path
          required: true
          description: The username
          schema:
            type: string
            pattern: "^[a-zA-Z0-9_-]{3,20}$"
            minLength: 2
            maxLength: 20
  '/user/{username}/tracks/current':
    get:
      summary: get current track
      tags:
        - user
      parameters:
        - name: username
          in: path
          required: true
          description: The username
          schema:
            type: string
            pattern: "^[a-zA-Z0-9_-]{3,20}$"
            minLength: 3
            maxLength: 20
        - name: signature
          in: query
          required: false
          description: the HMAC Signature for this OP
          schema:
            type: string
            pattern: "^[A-Fa-f0-9]{64}$"
            minLength: 64
            maxLength: 64
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserRecentTracks'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnauthorizedResponse'
        '500':
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/internalError'
      operationId: 'get_user_username_tracks_current'
      description: equivalent to calling recent with limit of 1
  '/user/{username}/tracks/current/embed':
    get:
      summary: get current track
      tags:
        - user
      parameters:
        - name: username
          in: path
          required: true
          description: The username
          schema:
            type: string
        - name: signature
          in: query
          required: false
          description: the HMAC Signature for this OP
          schema:
            type: string
      responses:
        '200':
          description: The operation was successful
          content: {}
        '500':
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiError'
      operationId: 'get-user-:username-tracks-current-embed'
      x-stoplight:
        id: r4nu8mvgwcbbf
      description: equivalent to calling recent with limit of 1
  /hmac/sign/base64:
    post:
      summary: sign a request
      tags:
        - hmac
        - hmac_base64
      responses:
        '200':
          description: successfully signed
      operationId: post-hmac-sign-base64
      x-stoplight:
        id: 1hthsq5tpk5xi
      parameters:
        - schema:
            type: string
          in: header
          name: HMAC-PSK
          description: HMAC Pre-Shared-Key
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/HmacProxyRequest'
      security: []
  /hmac/sign:
    post:
      summary: sign a request
      tags:
        - hmac
      responses:
        '200':
          description: successfully signed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HmacProxyRequest'
            application/yaml:
              schema:
                $ref: '#/components/schemas/HmacProxyRequest'
        '401':
          $ref: '#/components/responses/ApiErrorReturn401'
      operationId: post-hmac-sign
      x-stoplight:
        id: 1hthsq5tpk5xi
      parameters:
        - schema:
            type: string
          in: header
          name: HMAC-PSK
          description: HMAC Pre-Shared-Key
          required: true
        - schema:
            type: boolean
          in: query
          name: is_base64
          required: false
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/HmacProxyRequest'
      security: []
  /hmac/verify:
    post:
      summary: verify a hmac signed method
      tags:
        - hmac
      responses:
        '200':
          description: request success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Verification'
      operationId: get-hmac-verify
      x-stoplight:
        id: rrb5zs04683wq
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignedRequest'
      parameters:
        - schema:
            type: string
          in: header
          name: HMAC-PSK
          required: true
        - name: isBase64
          description: if the request is base64 encoded
          required: false
          deprecated: true
          in: query
          schema:
            type: boolean
        - name: is_base64
          description: if the request is base64 encoded
          required: false
          deprecated: true
          in: query
          schema:
            type: boolean
      security: []
  /hmac/verify/against_server:
    post:
      summary: Execute a signed HMAC proxy request
      tags:
        - hmac
      parameters:
        - name: is_base64
          description: if the request is base64 encoded
          required: false
          in: query
          schema:
            type: string
            enum:
              - false
              - true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignedRequest'
      responses:
        '200':
          description: Proxy request succeeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Verification'
        '400':
          description: Bad input or invalid JSON
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiError'
        '403':
          $ref: '#/components/responses/ApiErrorReturn403'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiError'
      security: [ ]
  /hmac/execute:
    post:
      summary: Execute a signed HMAC proxy request
      tags:
        - hmac
      parameters:
        - name: is_base64
          description: if the request is base64 encoded
          required: false
          in: query
          schema:
            type: boolean
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignedRequest'
      responses:
        '200':
          description: Proxy request succeeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HmacProxyResponse'
        '400':
          description: Bad input or invalid JSON
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiError'
        '403':
          description: Invalid signature or not authorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiError'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiError'
      security: []
    get:
      security: []
      summary: Execute a signed HMAC proxy request
      tags:
        - hmac
      parameters:
        - name: isBase64
          description: if the request is base64 encoded
          required: true
          deprecated: true
          in: query
          schema:
            type: boolean
            default: true
        - name: is_base64
          description: if the request is base64 encoded
          required: true
          in: query
          schema:
            type: boolean
            default: true
        - name: request
          description: base64 encoded request
          in: query
          required: true
          schema:
            type: string
        - name: signature
          in: query
          description: the signature of the request
          required: true
          schema:
            type: string
      responses:
        '200':
          description: successful request
  '/user/{username}/top/tracks':
    parameters:
      - schema:
          type: string
        name: username
        in: path
        required: true
    get:
      summary: get the top tracks
      tags:
        - user
      responses:
        '200':
          description: Request successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserTopTracks'
            application/xml:
              schema:
                $ref: '#/components/schemas/UserTopTracks'
            application/yaml:
              schema:
                $ref: '#/components/schemas/UserTopTracks'
        '401':
          description: Unauthorized
      operationId: get-user-username-top-tracks
      x-stoplight:
        id: l3tqqqu7any10
  '/user/{username}/top/albums':
    parameters:
      - schema:
          type: string
        name: username
        in: path
        required: true
    get:
      summary: get a user's topalbums
      tags: 
        - user
      responses:
        '200':
          description: success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserTopAlbums'
      operationId: get-user-username-top-albums
      x-stoplight:
        id: thto4eee1rct0
  /musicbrainz/lookup/artist/by_mbid/{artist_mbid}:
    parameters:
      - schema:
          type: string
        name: artist_mbid
        in: path
        required: true
    get:
      summary: lookup artist details by mbid
      tags:
        - musicbrainz
      operationId: get_musicbrainz_lookup_artist_by_mbid
      responses:
        '200':
          description: Request successful
      
security:
  - defaultApiKey: []
components:
  securitySchemes:
    defaultApiKey:
      description: The Api Key you obtained from lastfm
      type: apiKey
      name: Authorization
      in: header
  schemas:
    ApiErrorCode:
      type: number
      enum:
        - 0
        - 1
        - 2
        - 3
    Success:
      type: boolean
      description: If the operation was successfull
      example: false
    Verification:
      type: object
      description: wheather the verification was successfull
      properties:
        message:
          type: string
        success:
          type: boolean
    ApiError:
      type: object
      properties:
        http_code:
          type: number
          description: The HTTP Error Code
          example: 403
        internal_error_code:
          type: number
          description: The internal Error Code
          example: 1
        internal_error_msg:
          type: string
          nullable: true
          description: Internal Error message
        success:
          $ref: '#/components/schemas/Success'
        data:
          type: object
          nullable: true
        message:
          type: string
          example: Invalid HMAC signature
      required:
        - success
        - message
    HmacProxyResponse:
      type: object
      properties:
        signature:
          type: string
    HmacProxyRequest:
      type: object
      properties:
        method:
          type: string
          example: get
          description: lowercase http method
          enum:
            - "get"
            - "post"
            - "head"
        api_identifier:
          type: string
          example: /user/
          enum:
            - "/user/"
            - "/user/tracks/current/"
            - "/user/tracks/current/embed"
            - "/user/tracks/recent/"
        api_parameters:
          description: The Api Parameters you want to provide
          type: object
          required:
            - username
          properties:
            username:
              type: string
              example: alice
              description: The Username you want to specify
            page:
              type: number
              example: 1
              description: The page of the result you want to get
            limit:
              type: number
              example: 15
              description: The limit of a page
        body:
          type: string
          nullable: true
          default: null
      required:
        - method
        - api_identifier
    SignedRequest:
      type: object
      title: "The signed Request (not encoded)"
      properties:
        signature:
          type: string
          example: 4acfb7f8b2...
          pattern: "^[A-Fa-f0-9]{64}$"
          minLength: 64
          maxLength: 64
        request:
          $ref: '#/components/schemas/HmacProxyRequest'
      required:
        - signature
        - request
    SignedBase64Request:
      type: object
      title: "A signed Request Base64 encoded"
      properties:
        signature:
          type: string
          example: 4acfb7f8b2...
          pattern: "^[A-Fa-f0-9]{64}$"
          minLength: 64
          maxLength: 64
        request:
          type: string
      required:
        - signature
        - request
    userinfo:
      description: the User Info
      properties:
        id:
          type: number
        name:
          type: string
          pattern: "^[a-zA-Z0-9_-]{3,20}$"
          minLength: 3
          maxLength: 20
        realname:
          type: string
        url:
          type: string
          format: url
        imageurl:
          type: string
          format: url
        country:
          type: string
        age:
          type: number
        gender:
          type: string
        subscriber:
          type: number
        playcount:
          type: number
        playlists:
          type: number
        bootstrap:
          type: number
        registered:
          type: string
          format: date
    internalError:
      description: internal server error
      properties:
        code:
          type: number
        error:
          type: string
        data:
          properties:
            request:
              properties:
                host:
                  type: string
                path:
                  type: string
                query:
                  type: string
                method:
                  type: string
    LFMArtistSimple:
      type: object
      nullable: true
      properties:
        name:
          type: string
        mbid:
          type: string
          format: uuid
        url:
          type: string
          format: url
    UserLovedTracks:
      type: object
      properties:
        loved_tracks:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
                maxLength: 100
                minLength: 1
                description: Track Name
              mbid:
                type: string
                format: uuid
                nullable: true
                description: The musicbrainz id of the track
              url:
                type: string
                format: url
                description: The url to the lastfm entry of the track
              date:
                type: string
                format: date
              image:
                type: string
                format: url
                description: album cover image
              artist:
                $ref: '#/components/schemas/LFMArtistSimple'
              streamable:
                type: integer
                format: int32
                minimum: 0
                maximum: 255
      description: The tracks a user loves
    UserRecentTracks:
      type: object
      description: The Tracks a user listened to recently
      properties:
        track:
          type: array
          items:
            type: object
            required:
              - items
            properties:
              now_playing:
                type: boolean
                description: If the track is currently playing
                nullable: false
              name:
                type: string
                description: The Trackname
              track_mbid:
                type: string
                format: uuid
                description: The MusicBrainz identifier for the track
              url:
                type: string
                format: url
                description: The url to the lastfm entry
              date:
                type: string
                format: date
                description: The date of the scrobble
              timestamp:
                type: string
                format: date-time
              image:
                type: string
                format: url
              artist:
                $ref: '#/components/schemas/Artist'
              artist_mbid:
                type: string
                format: uuid
              streamable:
                type: number
              track_musicbrainz:
                $ref: '#/components/schemas/MusicbrainzRecording'
    UnauthorizedResponse:
      type: object
      properties:
        code:
          type: integer
          format: int64
          example: 403
          minimum: 100
          maximum: 599
        error:
          type: string
    UserTopAlbums:
      title: UserTopAlbums
      type: object
      properties:
        album:
          type: array
          items:
            $ref: '#/components/schemas/UserAlbums'
    UserAlbums:
      type: object
      properties:
        rank:
          type: integer
          format: int32
          minimum: 1
          maximum: 255
        name:
          type: string
        playcount:
          type: integer
          format: int64
          minimum: 0
          maximum: 32000
        mbid:
          type: string
          format: uuid
          nullable: true
        url:
          type: string
          format: url
          nullable: false
    UserTopTracks:
      title: UserTopTracks
      type: object
      properties:
        track:
          type: array
          items:
            type: object
            required:
              - items
            properties:
              name:
                type: string
              rank:
                type: integer
                description: The ranking
                format: int32
                minimum: 1
                maximum: 16000
              mbid:
                type: string
                format: uuid
                description: The musicbrainz identifier of the track
              url:
                type: string
                format: url
                description: the url of the lastfm entry
              date:
                type: string
                format: date
                description: the date of the scrobble
                nullable: true
              image:
                type: string
                format: url
                description: Link to the tracks image
              artist:
                $ref: '#/components/schemas/Artist'
    Artist:
      title: Artist
      type: object
      properties:
        name:
          type: string
          example: Linkin Park
          description: The name of the artist
        mbid:
          type: string
          format: uuid
        url:
          type: string
          format: url
          example: 'https://www.last.fm/music/Linkin+Park'
          description: The URL of the artist's entry on last.fm
    MusicbrainzRecording:
      type: object
      nullable: true
      properties:
        recording:
          type: object
          properties:
            text:
              type: string
            id:
              type: string
              format: uuid
            title:
              type: string
            length:
              type: integer
              format: int32
              minimum: 0
              maximum: 2147483647
            artist_credit:
              type: object
              properties:
                name_credit:
                  type: array
                  items:
                    type: object
                    properties:
                      text:
                        type: string
                      joinphrase:
                        type: string
                        example: "feat."
                      artist:
                        $ref: '#/components/schemas/Artist'
            release_list:
              type: object
            isrc_list:
              type: object
  responses:
    ApiErrorReturn401:
      description: Api Error 401
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ApiError'
        application/yaml:
          schema:
            $ref: '#/components/schemas/ApiError'
        application/xml:
          schema:
            $ref: '#/components/schemas/ApiError'
    ApiErrorReturn403:
      description: Api Error 401
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ApiError'
        application/yaml:
          schema:
            $ref: '#/components/schemas/ApiError'
        application/xml:
          schema:
            $ref: '#/components/schemas/ApiError'
x-internal: true
